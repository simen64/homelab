steps:
  build-komodo-core:
    when:
      - event: push
        path:
          include: ["images/komodo-core/**", "images/resources/**"]
      - event: cron
        cron: nightly_build

    image: woodpeckerci/plugin-docker-buildx
    pull: true
    settings:
      dry-run: false
      username:
        from_secret: registry_username
      password:
        from_secret: registry_password
      platforms: linux/amd64
      registry: forgejo.simenmo.com
      repo: forgejo.simenmo.com/simen/homelab/komodo-core
      tag: latest
      dockerfile: images/komodo-core/containerfile
      context: "images/"

  build-komodo-agent:
    when:
      - event: push
        path:
          include: ["images/komodo-agent/**", "images/resources/**"]
      - event: cron
        cron: nightly_build

    image: woodpeckerci/plugin-docker-buildx
    pull: true
    settings:
      dry-run: false
      username:
        from_secret: registry_username
      password:
        from_secret: registry_password
      platforms: linux/amd64
      registry: forgejo.simenmo.com
      repo: forgejo.simenmo.com/simen/homelab/komodo-agent
      tag: latest
      dockerfile: images/komodo-agent/containerfile
      context: "images/"

  build-komodo-agent-gpu:
    when:
      - event: push
        path:
          include: ["images/komodo-agent/**", "images/resources/**"]
      - event: cron
        cron: nightly_build

    image: woodpeckerci/plugin-docker-buildx
    pull: true
    settings:
      dry-run: false
      username:
        from_secret: registry_username
      password:
        from_secret: registry_password
      platforms: linux/amd64
      registry: forgejo.simenmo.com
      repo: forgejo.simenmo.com/simen/homelab/komodo-agent-gpu
      tag: latest
      dockerfile: images/komodo-agent/containerfile-nvidia
      context: "images/"
